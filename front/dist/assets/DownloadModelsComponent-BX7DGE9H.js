import{_ as re,r as p,u as ne,a as ie,K as q,c as y,o as de,b as n,d as s,B as w,e as b,w as ce,v as ue,q as S,s as B,g as R,t as h,z as j,A as r,L as ge,M as he}from"./index-DsIss_bJ.js";import{A as fe}from"./AccordionComponent-D14leHG-.js";const xe={class:"download-models-container w-full p-4 space-y-4"},ve={class:"models-card bg-background-soft border border-border rounded-lg shadow-md"},pe={class:"flex items-center justify-between p-4 border-b border-border"},ye={class:"header-actions flex gap-2"},we=["disabled"],be=["disabled"],_e={class:"p-4 space-y-4"},ke={class:"filter-section bg-background-mute border border-border rounded-lg p-4 space-y-3"},me={class:"flex items-center gap-2 mb-2"},De={class:"relative"},Ce={key:0,class:"space-y-2"},Ae={class:"flex flex-wrap gap-2"},Te=["onClick"],Me={key:0,class:"ml-1"},Se={key:1,class:"text-xs text-text-light-muted"},Be={key:0},je={key:1},Fe={key:0,class:"text-center text-text-light-muted py-8"},Oe={key:1,class:"space-y-4"},Le={class:"table-responsive"},$e={class:"overflow-x-auto"},Ee={class:"w-full text-sm"},Ve={class:"bg-background-mute"},Ge={class:"p-2 text-left"},Ne=["checked","onChange","disabled"],Pe={class:"p-2"},ze=["checked","onChange","disabled"],Ke={class:"p-2"},He={class:"p-2"},Ie={key:0,class:"flex flex-wrap gap-1"},qe={key:1,class:"text-text-light-muted"},Re={class:"p-2 text-text-light"},Ue={class:"p-2 text-text-light"},We={class:"p-2"},Ye=["href"],Je={key:1,class:"text-text-light-muted"},Qe={class:"p-2"},Xe={class:"p-2"},Ze={class:"flex gap-2"},et=["onClick","disabled"],tt=["onClick","disabled"],st={name:"DownloadModelsComponent"},at=Object.assign(st,{setup(ot){const _=p([]),U=p({}),i=p({}),F=p(!1),f=p(""),d=p([]),{showNotification:x,showDialog:A}=ne(),{rawDownloads:O,refreshDownloads:L,startGlobalDownloadPolling:$}=ie(),k=O,T=async()=>{F.value=!0;try{const{data:e}=await j.get("/models/"),t={};let o=[];for(const[l,a]of Object.entries(e.groups||{}))t[l]=a,o=o.concat(a.map(g=>({...g,group:l})));_.value=o,U.value=t,i.value={...i.value}}finally{F.value=!1}};let E={};q(()=>{for(const e in E)if(!(e in k.value)||k.value[e]&&k.value[e].progress===100){T();break}E={...k.value}}),y(()=>Object.entries(k.value).map(([e,t])=>({entry:_.value.find(l=>(l.dest||l.git)===e)||{},progress:t.progress,status:t.status}))),p(!1);const M=p([]),W=(e,t)=>{const o=M.value.indexOf(e);t&&o===-1?M.value.push(e):!t&&o>-1&&M.value.splice(o,1)},Y=(e,t)=>{const o=c(e);t?i.value[o]=!0:delete i.value[o],i.value={...i.value}},V=y(()=>{const e=new Set;return _.value.forEach(t=>{t.tags&&(Array.isArray(t.tags)?t.tags.forEach(o=>e.add(o)):e.add(t.tags))}),Array.from(e).sort()}),G=y(()=>{let e=_.value;if(f.value.trim()){const t=f.value.toLowerCase().trim();e=e.filter(o=>{const l=(m(o.dest)||o.git||"").toLowerCase(),a=o.tags?(Array.isArray(o.tags)?o.tags.join(" "):o.tags).toLowerCase():"";return l.includes(t)||a.includes(t)})}return d.value.length>0&&(e=e.filter(t=>{if(!t.tags)return!1;const o=Array.isArray(t.tags)?t.tags:[t.tags];return d.value.every(l=>o.some(a=>a.toLowerCase()===l.toLowerCase()))})),e}),N=y(()=>{const e={};return G.value.forEach(t=>{const o=t.group||"Other";e[o]||(e[o]=[]),e[o].push(t)}),e}),J=e=>{const t=d.value.indexOf(e);t>-1?d.value.splice(t,1):d.value.push(e)},Q=()=>{f.value="",d.value=[]},c=e=>e.url||e.git,m=e=>(e==null?void 0:e.split("/").pop())||"",X=e=>e?e>1e9?(e/1e9).toFixed(2)+" GB":e>1e6?(e/1e6).toFixed(2)+" MB":e>1e3?(e/1e3).toFixed(2)+" KB":e+" B":"-",Z=e=>{const t=e.tags;return t?Array.isArray(t)?t.includes("nsfw"):t==="nsfw":!1},u=e=>!!k.value[c(e)],ee=e=>e.filter(t=>!u(t)).every(t=>i.value[c(t)]),te=(e,t)=>{for(const o of e)u(o)||(i.value[c(o)]=t)},D=y(()=>_.value.filter(e=>i.value[c(e)]&&e.exists)),C=y(()=>_.value.filter(e=>i.value[c(e)]&&!e.exists&&!k.value[c(e)]));q(()=>{console.log("selectedToDelete:",D.value.map(e=>c(e))),console.log("selectedToDownload:",C.value.map(e=>c(e)))});const P=y(()=>D.value.length>0),z=y(()=>C.value.length>0);function K(e){for(const t of e)delete i.value[c(t)];i.value={...i.value}}const se=async()=>{if(!D.value.length)return;await A({title:"Delete selected models",message:`Are you sure you want to delete ${D.value.length} model(s)?`,type:"confirm",confirmText:"Delete",cancelText:"Cancel"})&&(await H(D.value),K(D.value))},ae=async()=>{if(!C.value.length)return;await A({title:"Download selected models",message:`Download ${C.value.length} model(s)?`,type:"confirm",confirmText:"Download",cancelText:"Cancel"})&&(await I(C.value),K(C.value))};async function H(e){try{const t=await j.post("/models/delete",e);let l=(Array.isArray(t.data)?t.data:[t.data]).filter(a=>!a.ok);l.length?l.forEach(a=>x(a.msg||"Delete failed","error")):x(Array.isArray(e)&&e.length>1?"Selected models deleted":"Model deleted","success"),await T()}catch{x("Delete operation failed","error")}}async function I(e){try{const o=(Array.isArray(e)?e:[e]).filter(v=>u(v));if(o.length>0){x(`Some models are already downloading: ${o.map(v=>m(v.dest)||v.git).join(", ")}`,"warning");return}$();const l=await j.post("/models/download",e);let g=(Array.isArray(l.data)?l.data:[l.data]).filter(v=>!v.ok);g.length?g.forEach(v=>x(v.msg||"Download failed","error")):(x(Array.isArray(e)&&e.length>1?"Selected models downloading":"Download started","success"),setTimeout(async()=>{await L(),console.log("Downloads refreshed after POST, current downloads:",Object.keys(O.value))},1e3)),await T()}catch{x("Download operation failed","error")}}const oe=async e=>{if(u(e)){x(`Model "${m(e.dest)||e.git}" is already downloading`,"warning");return}await A({title:"Download model",message:`Download model "${m(e.dest)||e.git}"?`,type:"confirm",confirmText:"Download",cancelText:"Cancel"})&&await I(e)},le=async e=>{await A({title:"Delete model",message:`Delete model "${m(e.dest)||e.git}"?`,type:"confirm",confirmText:"Delete",cancelText:"Cancel"})&&await H(e)};return de(async()=>{await T(),await L(),$()}),(e,t)=>(r(),n("div",xe,[s("div",ve,[s("div",pe,[t[1]||(t[1]=s("div",{class:"flex items-center gap-2"},[s("svg",{class:"w-6 h-6 text-white",fill:"currentColor",viewBox:"0 0 20 20"},[s("path",{d:"M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"})]),s("span",{class:"text-lg font-bold text-white"},"Model Manager")],-1)),s("div",ye,[s("button",{disabled:!P.value,onClick:se,class:w(["px-4 py-2 rounded text-sm font-medium transition-colors",P.value?"bg-red-600 hover:bg-red-700 text-white":"bg-gray-600 text-gray-400 cursor-not-allowed"])},"Delete selected",10,we),s("button",{disabled:!z.value,onClick:ae,class:w(["px-4 py-2 rounded text-sm font-medium transition-colors",z.value?"bg-primary hover:bg-primary-dark text-white":"bg-gray-600 text-gray-400 cursor-not-allowed"])},"Download selected",10,be)])]),s("div",_e,[s("div",ke,[s("div",me,[t[2]||(t[2]=s("svg",{class:"w-5 h-5 text-text-light",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"})],-1)),t[3]||(t[3]=s("span",{class:"font-medium text-text-light"},"Filters",-1)),f.value||d.value.length>0?(r(),n("button",{key:0,onClick:Q,class:"ml-auto px-2 py-1 text-xs bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors"}," Clear All ")):b("",!0)]),s("div",De,[ce(s("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>f.value=o),type:"text",placeholder:"Search by name or tags...",class:"w-full px-3 py-2 pl-10 bg-background border border-border rounded-md text-text-light placeholder-text-light-muted focus:outline-none focus:ring-2 focus:ring-primary"},null,512),[[ue,f.value]]),t[4]||(t[4]=s("svg",{class:"absolute left-3 top-2.5 w-4 h-4 text-text-light-muted",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),V.value.length>0?(r(),n("div",Ce,[t[5]||(t[5]=s("span",{class:"text-sm font-medium text-text-light"},"Filter by tags:",-1)),s("div",Ae,[(r(!0),n(S,null,B(V.value,o=>(r(),n("button",{key:o,onClick:l=>J(o),class:w(["px-3 py-1 text-xs rounded-full border transition-colors",d.value.includes(o)?"bg-primary text-white border-primary":"bg-background border-border text-text-light hover:bg-background-mute"])},[R(h(o)+" ",1),d.value.includes(o)?(r(),n("span",Me,"Ã—")):b("",!0)],10,Te))),128))])])):b("",!0),f.value||d.value.length>0?(r(),n("div",Se,[R(" Showing "+h(G.value.length)+" of "+h(_.value.length)+" models ",1),f.value?(r(),n("span",Be,' matching "'+h(f.value)+'"',1)):b("",!0),d.value.length>0?(r(),n("span",je," with tags: "+h(d.value.join(", ")),1)):b("",!0)])):b("",!0)]),Object.keys(N.value).length===0?(r(),n("div",Fe,h(f.value||d.value.length>0?"No models match the current filters.":"No models found."),1)):(r(),n("div",Oe,[(r(!0),n(S,null,B(N.value,(o,l)=>(r(),ge(fe,{key:l,title:l,defaultOpen:M.value.includes(l),onToggle:a=>W(l,a)},{default:he(()=>[s("div",Le,[s("div",$e,[s("table",Ee,[s("thead",Ve,[s("tr",null,[s("th",Ge,[s("input",{type:"checkbox",checked:ee(o),onChange:a=>te(o,a.target.checked),disabled:o.every(a=>u(a)),class:"rounded"},null,40,Ne)]),t[6]||(t[6]=s("th",{class:"p-2 text-left text-text-light"},"Name",-1)),t[7]||(t[7]=s("th",{class:"p-2 text-left text-text-light"},"Tags",-1)),t[8]||(t[8]=s("th",{class:"p-2 text-left text-text-light"},"Type",-1)),t[9]||(t[9]=s("th",{class:"p-2 text-left text-text-light"},"Size",-1)),t[10]||(t[10]=s("th",{class:"p-2 text-left text-text-light"},"Source",-1)),t[11]||(t[11]=s("th",{class:"p-2 text-left text-text-light"},"Present",-1)),t[12]||(t[12]=s("th",{class:"p-2 text-left text-text-light"},"Action",-1))])]),s("tbody",null,[(r(!0),n(S,null,B(o,a=>(r(),n("tr",{key:c(a),class:w(["border-b border-border hover:bg-background-mute transition-colors",u(a)?"is-downloading":""])},[s("td",Pe,[s("input",{type:"checkbox",checked:i.value[c(a)]||!1,onChange:g=>Y(a,g.target.checked),disabled:u(a),class:"rounded"},null,40,ze)]),s("td",Ke,[s("span",{class:w(["font-medium",u(a)?"opacity-50":"",Z(a)?"text-red-400":"text-text-light"])},h(m(a.dest)||a.git),3)]),s("td",He,[a.tags&&a.tags.length?(r(),n("div",Ie,[(r(!0),n(S,null,B(Array.isArray(a.tags)?a.tags:[a.tags],g=>(r(),n("span",{key:g,class:"px-2 py-1 bg-blue-600 text-white text-xs rounded"},h(g),1))),128))])):(r(),n("span",qe,"-"))]),s("td",Re,h(a.type||l),1),s("td",Ue,h(a.size?X(a.size):"-"),1),s("td",We,[a.src?(r(),n("a",{key:0,href:a.src,target:"_blank",rel:"noopener",class:"text-primary hover:text-primary-light underline"}," Link ",8,Ye)):(r(),n("span",Je,"-"))]),s("td",Qe,[s("span",{class:w(["px-2 py-1 text-xs rounded",a.exists?"bg-green-600 text-white":"bg-red-600 text-white"])},h(a.exists?"Yes":"No"),3)]),s("td",Xe,[s("div",Ze,[a.exists?b("",!0):(r(),n("button",{key:0,onClick:g=>oe(a),disabled:u(a),class:w(["px-3 py-1 rounded text-sm transition-colors",u(a)?"bg-gray-600 text-gray-400 cursor-not-allowed":"bg-primary hover:bg-primary-dark text-white"])}," Download ",10,et)),a.exists?(r(),n("button",{key:1,onClick:g=>le(a),disabled:u(a),class:w(["px-3 py-1 rounded text-sm transition-colors",u(a)?"bg-gray-600 text-gray-400 cursor-not-allowed":"bg-red-600 hover:bg-red-700 text-white"])}," Delete ",10,tt)):b("",!0)])])],2))),128))])])])])]),_:2},1032,["title","defaultOpen","onToggle"]))),128))]))])])]))}}),nt=re(at,[["__scopeId","data-v-6653bf17"]]);export{nt as default};
